### Атаки первичного доступа на Windows машины

Атаки первичного доступа на Windows машины могут быть предприняты после их обнаружения и использовать следующие
способы атак:

- Применение эксплойтов к известным уязвимостям Windows машин
- Применение атак методом перебора
- Перехват трафика и атаки MiTM

### Применение эксплойтов

Мы уже знакомы с возможностью обнаруживать уязвимые версии ПО и применять к ним эксплойты. Поговорим о типовых
уязвимостях и эксплойтов для Windows машин.

Самыми распространенными уязвимостями Windows машин в разное время являлись:

    CVE-2008-4250 (MS08-067)
    CVE-2017-0143 (MS17-010)
    CVE- 2019-0708 (BlueKeep)
    -----> Более полный список

**MS08-067**

MS08_067_netapi — один из самых популярных удаленных эксплойтов против Microsoft Windows. Он считается надежным
эксплойтом и позволяет получить доступ как SYSTEM — это наивысшая привилегия Windows. В современных тестах на
проникновение этот эксплойт, скорее всего, будет использоваться во внутренней среде и не так часто — во внешней, из-за
вероятности наличия брандмауэра.

Этот эксплойт работает против уязвимой службы SMB для следующих систем Windows:

    Windows 2000
    Windows XP
    Windows 2003
    -----> Эксплоит: Metasploit > exploits/windows/smb/ms08_067_netapi

**MS17-010**

MS17_010_eternalblue — удаленный эксплойт против Microsoft Windows, изначально написанный Equation Group (АНБ) и
разглашенный Shadow Brokers (неизвестной хакерской организацией). Он считается надежным эксплойтом и позволяет не только
получить доступ как SYSTEM, но и полный контроль над ядром в кольце 0.

Что касается удаленных эксплойтов для ядра, этот эксплойт очень надежен и безопасен в использовании. Команда проверки
также очень точна, поскольку патч Microsoft непреднамеренно добавил раскрытие информации с дополнительными проверками на
уязвимые пути кода.

Этот эксплойт работает против уязвимой службы SMB для следующих систем Windows:

    Windows XP x86 (All Service Packs)
    Windows 2003 x86 (All Service Packs)
    Windows 7 x86 (All Service Packs)
    Windows 7 x64 (All Service Packs)
    Windows 2008 R2 x64 (All Service Packs)
    Windows 8.1 x64
    Windows Server 2012 R2 x64
    Windows 10 Pro x64 (< Version 1507)
    Windows 10 Enterprise Evaluation x64 (< Version 1507)
    -----> Эксплоит: Metasploit > exploit/windows/smb/ms17_010_eternalblue

**BlueKeep**

Уязвимость BlueKeep была обнаружена в реализации протокола RDP в некоторых версиях ОС Windows в мае 2019. BlueKeep никак
не относится к механизму работы самого протокола и затрагивает только его реализацию. В частности, уязвимость
затрагивает часть кода, отвечающую за управление так называемыми виртуальными каналами (англ. virtual channels).

Уязвимость в настоящее время нацелена на следующие системы Windows:

    Windows 10
    Windows 7
    Windows 8.1
    Windows Server 2008 R2
    Windows Server 2012
    Windows Server 2012 R2
    Windows Server 2016
    Windows Server 2019
    -----> Эксплоит: Metasploit > exploit/windows/rdp/cve_2019_0708_bluekeep_rce

### Атаки методом перебора

Не менее эффективными для атак на Windows машины являются и атаки методом перебора: в каждой Windwos машине есть по
несколько протоколов, позволяющих реализовывать атаки на механизмы аутентификации. Небольшое понимание того, какие
учетные данные и пароли использовать для подобных атак в определенном контексте, может сильно облегчить этот способ и
сделать его крайне эффективным.

Что может быть подвергнуто атаке в Windows:

SMB
MSSQL
LDAP
RDP
Пример атаки:
> hydra -L ~/wordlists/user.txt -P ~/wordlists/pass.txt 192.168.1.5 smb -V

Подготовка
Перед тем, как провести атаку методом перебора, необходимо ответить на следующие вопросы:

Можно ли узнать логины для пользователей в домене?
Какие пароли использовать для подбора?
Как не заблокировать пользователей в домене?

Словарь логинов
Словарь логинов из домена можно получить следующими способами:

    С этапа разведки;
    С внешних систем (почта);
    Скомпрометировав какую-либо машину / аккаунт: извлечь адресную книгу почты / получить доступ к LDAP

#### Словарь паролей

Словарь паролей можно подготовить, зная привычки / менталитет сотрудников компании. Самыми популярными паролями будут:
Zima2023 , Vfhn2023 (Март2023), Company2023 и пр., т.е.: использование комбинаций года, месяца, имени компании и пр.

Словари нужно подбирать в соответствии с контекстом, в котором вы их используете.

Обход блокировки
Для обхода блокировки можно использовать атаку PasswordSpraying: 1 попытку подбора пароля для всех аккаунтов в списке в
определенный период времени.

Особенность настройки систем Windows в том, что администраторы зачастую настраивают политику количества попыток ввода
пароля. Обычно количество попыток в этой политике устанавливается в значение от 3-х до 10-ти раз в течение часа. В
случае, если количество попыток превышено, аккаунт пользователя блокируется.

### Перехват трафика и MiTM-атаки на машины Windows

Еще одна особенность Windows машин в том, что они по умолчанию используют протоколы взаимодействия в локальной сети,
через которые можно попытаться скомпрометировать каналы коммуникаций и получить доступ к управлению сеансами или
данными в них.

Мы уже говорили ранее о выполнении Windows машиной алгоритма по разрешению имен в локальной сети.

Повторим:
каждый раз, когда машина Windows пытается выполнить разрешение доменного имени, она выполняет следующие действия:

    Проверяет файл hosts для получения информации о системе и ее конфигурации
    Проверяет локальный кэш DNS
    Отправляет запрос к DNS
    Отправляет запрос LLMNR
    Отправляет запрос NBT-NS
    Отправляет запрос MDNS

Как раз в момент использования протоколов LLMNR, NBT-NS и MDNS становится возможным подменить ответ на такой запрос и
попытаться завести жертву на свой зловредный ресурс, который сможет:

- Направить жертву в сервис аутентификации и украсть хеш пароля аккаунта (а впоследствии — и сам пароль)
- Провести атаку Relay (захвата сеанса), выполнения команд от имени жертвы в машине, где она прошла аутентификацию, и
  пр.
  Эта атака называется LLMNR / NBT-NS / MDNS Spoofing.

### Как работает NBT-NS и LLMNR Spoofing?

В момент получения запроса LLMNR/NBT-NS злоумышленник может подделать реальный источник разрешения имен в сети
жертвы. Он отвечает на трафик так, как будто ему известна личность запрашиваемого узла: отправляет службу, чтобы жертвы
общались с системой, контролируемой злоумышленником.

Если узел, на который будет перенаправлена жертва, потребует прохождения процесса идентификации / аутентификации, имя
пользователя и хэш NTLMv2 будут отправлены в систему, контролируемую злоумышленником. Затем противник может собрать
хэш-информацию с помощью инструментов, отслеживающих трафик, и взломать хэши в автономном режиме методом грубой силы,
чтобы получить пароли в открытом виде.

Для проведения подобной атаки можно использовать такие инструменты, как: NBNSpoof, Metasploit и Responder.

**Responder**
    
    Познакомимся поближе с проведением атаки LLMNR/NBT-NS/MDNS Spoofing с использованием Responder.
    
    -----> Ссылка на инструмент: https://github.com/SpiderLabs/Responder

Responder — это инструмент для выполнения атаки MiTM в отношении методов аутентификации в Windows. Эта программа
использует отправление LLMNR, NBT-NS и MDNS, через которое перенаправляет трафик с запросами и хешами аутентификации на
подконтрольный узел.
Также в программу встроены серверы аутентификации HTTP/SMB/MSSQL/FTP/LDAP, которые поддерживают такие методы
аутентификации, как NTLMv1/NTLMv2/LMv2, Extended Security NTLMSSP и базовую HTTP аутентификацию. Для них
Responder выполняет роль ретранслятора.

Попробуем воспользоваться этим инструментом и украсть хеш пароля жертвы, а потом восстановить ее пароль аккаунта:

Запустим Responder:
>sudo responder -I eth0

Перехватив NTLMv2 хеш, положим их в файл tickets.txt и попробуем восстановить пароли аккаунтов, отправивших нам хеши:
>hashcat -a 0 -w 4 -m 5600 tickets.txt /usr/share/wordlists/rockyou.txt

После получения пароля воспользуемся утилитой evil-winrm для получения удобного доступа к терминальной оболочке сервера:
>evil-winrm -i [ip] -u [username] -p [password]
