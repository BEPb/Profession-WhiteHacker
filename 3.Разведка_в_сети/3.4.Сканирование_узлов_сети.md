### Сканирование узлов сети

Сканирование узлов сети работает благодаря устройству таких протоколов, как: ICMP, TCP/UDP и ARP

**ICMP** — это протокол сетевого уровня стека TCP/IP, предназначенный для передачи сервисных сообщений. Обычно
используется
для передачи сообщений об ошибках и других исключительных ситуациях, возникших при передаче данных, например,
недоступность узла. ICMP включает в себя несколько типов сообщений, и в их числе echo request(8) и echo response(0),
которые используются для проверки доступности: если узел получил эхо-запрос, он отправляет обратно эхо-ответ, что
говорит об его доступности

Довольно часто ICMP-трафик в сети может быть заблокирован администраторами, поэтому обнаружить узлы обычным эхо-запросом
не выйдет. В таком случае можно просто отправить TCP или UDP сообщение на какой-нибудь порт, и если ответ придет, делаем
вывод, что узел под этим адресом существует в сети.

**ARP** — это протокол канального уровня, позволяющий узнать MAC-адрес узла по его IP и наоборот. MAC-адрес, как и
IP,может
быть полезной информацией для исследователя, но он может быть получен таким образом в пределах одной локальной сети, так
как ARP-запрос отправляется по broadcast MAC-адресу (FF:FF:FF:FF:FF:FF) и ограничивается одной подсетью.

### Алгоритм действий по сканированию узлов сети

На примере самого распространенного сканера сети Nmap рассмотрим, как можно просканировать произвольное пространство
сети.

Определить адрес подсети, в которой будет производится поиск узлов. Например, 192.168.88.0/24
Провести Ping-сканирование сети:

```commandline
nmap -sn--traceroute <network>
```

-sn — ping-сканирование. По умолчанию посылаются запрос на ICMP,эхо-запрос и TCP-ACK пакет на порт 80.
--traceroute — также для того, чтобы проводить трассировку маршрута до каждого найденного узла. Эта опция может помочь в
составлении карты подсети.
Если есть подозрение, что ICMP-пакеты и TCP-ACK сообщения блокируются сетевым экраном, можно применить другие виды
сканирования:
-PS — TCP-SYN сканирование
-PU — UDP сканирование
-PE; -PP; -PM — ICMP-сканирование других типов: запрос временной метки (13), информационный запрос (15), запрос адресной
маски (17). Многие узлы и брандмауэры могут блокировать исключительно ICMP-пакеты типа echo request, но в спецификации
ICMP присутствуют еще несколько типов запросов, позволяющих получить ответ от узлов.
Если после выполнения команд Nmap предоставил список доступных узлов, то сканирование может считаться успешным.
Пример

В данном примере используется флаг -sn, отключающий сканирование портов на обнаруженных узлах, он нужен, чтобы сократить
время сканирования и исключить поиск сервисов.

Nmap выдал ответ:

IP-адрес 192.168.88.1
MAC адрес производителя сетевой карты:2C:C8:1B:56:C7:39 (Routerboard.com) - выдаст MAC, если находимся в одной подсети
А также продемонстрировал прямой маршрут traceroute до узла, заключающийся в одном "прыжке" до адреса роутера (это
расстояние также называется "хопом" от английского слова "hop", англ. "hop" - "прыжок"; термин используется в описании
сетевых протоколов IP и пр.).

### Когда и как применять сканирование узлов сети?

Сканирование сети применяется на начальном этапе сбора информации для получения информации об используемых IP-адресах в
сети. Сканирование применяют при отсутствии какой-либо подобной информации о сети и инфраструктуре.

Эта техника дает информацию о доступных устройствах в сети. Однако она дает информацию только об их существовании и
доступности, и не более того, в отличие от техники сканирования портов, дополнительно дающей информацию об открытых
портах и сервисах, запущенных на них.

Для применения этой техники как минимум должен быть известен адрес целевой подсети, все остальное выполняет сетевой
сканер.

**Сканирование сети** — самый быстрый и эффективный способ обнаружение узлов в сети, однако это активный метод сбора
информации, и использование этой техники несет за собой высокий риск обнаружения, так как большинство современных
анализаторов трафика и IDS/IPS-систем умеют распознавать работу сетевого сканера, поэтому технику стоит использовать в
случаях, когда скрытность не имеет особого значения для хакера.

### Эффективность техники сканирования узлов сети

Эффективность техники измеряется в ее:

Скорости
Скрытности
Качестве результатов
Как повысить эффективность техники
Повысить скорость сканирования на примере сканера Nmap можно:

1. Указав опцию -sn, говорящей nmap не делать сканирование портов после обнаружения узла. Таким образом, время не будет
   тратиться на сканирование множества портов, которые nmap сканирует по умолчанию и будет происходить чисто обнаружение
   узлов

2. Указав опцию -n, отключающей разрешение DNS-имен. По умолчанию при обнаружении узлов nmap также производит обратное
   DNS разрешение, для того, чтобы по найденным ip-адресам попробовать узнать их доменные имена. Это не всегда
   требуется, и отключение разрешения имен может ускорить процесс сканирования

3. Используя опции таймингов -T3, -T4, -T5, и т.д., которые изменяют интервал между сетевыми запросами (чем выше число,
   тем меньше интервалы между запросами и тем быстрее выполнится скан) Возможные варианты: paranoid(0), sneaky(1),
   polite(2), normal(3), aggressive(4) и insane(5). Первые два помогают уклоняться от идентификации атакующего. 2 режим
   замедляет сканирование. 3 режим это по умолчанию, то есть никакой оптимизации не будет по данному ключу. 4 режим
   ускоряет сканирование. 5 режим очень быстро сканирует, но есть вероятность в потере точности при сканировании.
   Пример: nmap -Т4 <example.com>.

Скрытность на примере сканера Nmap может быть повышена, если:

1. Использовать опцию --data-length <length>, добавляющей случайных байтов информации к каждому пакету, что помогает
   сделать сканирование менее заметным и более похожим на пакеты, генерируемые программой ping.

2. Добавить опцию --randomize-hosts, перемешивающую сканирование узлов, чтобы сделать сканирование менее подозрительным
   при анализе трафика

Качество результатов:

Повышается за счет использования разных видов сканирования, основанных на разных протоколах — таким образом, если
некоторые протоколы фильтруются брандмауэром, результат можно получить, используя другие. Например, довольно часто
системными администраторами блокируется трафик ICMP, в таком случае можно попробовать TCP/UDP сканирование.

Комбинации

Для наиболее сложных задач сканирования (например, при больших количествах) можно пользоваться комбинированием
алгоритмов и инструментов: например, если целевая сеть большая и может содержать несколько подсетей, можно быстро
прогнать masscan по всей сети, чтобы определить подсети в ней, а затем уже по найденным подсетям меньшего размера идти
nmap-ом

Пример использования masscan:

masscan 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12 -p80 --open-only
Здесь идет сканирование трех больших сетей 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12 по 80 порту

Для повышения скрытности можно реализовать возможность использования фиктивных хостов (decoys) с опцией -D для того,
чтобы скрыть IP-адрес атакующего от IDS/IPS систем.

