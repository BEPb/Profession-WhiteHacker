#### Основные понятия

**Сегмент сети** — логически или физически обособленная часть сети. Разбиение сети на сегменты осуществляется с целью
оптимизации сетевого трафика и/или повышения безопасности сети в целом.

**Атака** «человек посередине» (англ. Man in the middle (MITM)) — вид атаки в компьютерной безопасности, когда
злоумышленник тайно ретранслирует и при необходимости изменяет связь между двумя сторонами, которые считают, что они
непосредственно общаются друг с другом.

Мы уже разобрались с тем, как закреплять доступ к скомпрометированной системе в пределах ДМЗ сети. Теперь мы переходим к
новому этапу: выход за рамки демилитаризованной зоны.

Единственной и самой важной целью выхода за рамки ДМЗ сети является получение доступа к внутренним ресурсам организации,
хранящим её конфиденциальные данные.

#### Разбор базового примера

Компрометация одного из узлов сети ДМЗ
Вы получили доступ к ОС в сети ДМЗ, но ваша задача — добраться до пользовательских станций и частных серверов в
локальной сети организации.

Ход действий

#### Способ 1

1. Осуществляем базовое сканирование: проверяем топ-100 TCP портов без осуществления ping-сканирования и проверки
   DNS-записи, определяем версии сервисов:

         $ nmap -sT -Pn -n -F -sV --open 10.8.0.14

    2. Обнаруживаем сервисы, видим, что это устройства Mikrotik версии 6.40.7. Ищем информацию о уязвимостях, наиболее
       подходящей является CVE-2020-20214. Запускаем Metasploit Framework и ищем модули для эксплуатации этой и других
       уязвимостей:

             $ msfconsole
          
             msf6 > search Mikrotik
          
             msf6> use auxiliary/gather/mikrotik_winbox_fileread
          
             msf6> info

        3. В описании модуля видим уязвимую версию 6.40.7, следовательно, это устройство с высокой вероятностью будет
           ему
           подвержено. Так как данная уязвимость имеет тип directory traversal, мы можем использовать модуль для чтения
           произвольных файлов на атакуемом устройстве, а именно – для чтения логов смены паролей, раскрывающих учетные
           данные в
           открытом виде:

           msf6> set RHOSTS 10.8.0.14

           msf6> run

4. Получаем логин и пароль администратора устройства.

#### Способ 2

Данную уязвимость можно было бы проэксплуатировать без MSF, с помощью отдельного
эксплойта: https://www.exploit-db.com/exploits/45578

1. Зайдем в интерфейс управления устройства через браузер используя извлеченный пароль:


2. Панель администрирования роутера позволяет получить информацию о сетевых интерфейсах, изменять правила сетевого
   экрана и использовать его для доступа в атакуемую сеть.

Для того, чтобы компрометировать сеть ДМЗ, надо понимать, как она устроена:

- из каких узлов состоит;
- какие возможности даёт каждый из узлов;
- как устроены протоколы взаимодействия.

### Настройка ДМЗ сети

Настройка ДМЗ сети зависит от конкретного сценария и используемого сетевого оборудования. Однако, общие шаги при
настройки ДМЗ сети могут быть следующими:

- Определено сетевое оборудование, которое будет использоваться для настройки ДМЗ сети: это может быть отдельный
  маршрутизатор или фаервол либо специальный модуль для управления трафиком на маршрутизаторе
- Определены IP-адреса для устройств, которые будут находиться в ДМЗ сети: эти устройства имеют свои уникальные
  IP-адреса,
  отличные от адресов локальной сети и сети Интернет
- Настроен маршрутизатор или фаервол, чтобы создать отдельную сеть для ДМЗ: эта сеть должна быть отделена от локальной
  сети и сети Интернет с помощью фильтров и правил безопасности
    - Настроены правила безопасности, чтобы контролировать доступ к устройствам в ДМЗ сети: эти правила должны
      обеспечивать
      защиту от внешних атак, но также позволять управлять устройствами в ДМЗ сети из локальной сети

            В сеть ДМЗ могут получать доступ как узлы из недоверенной зоны, так и из внутренней доверенной зоны, но из сети ДМЗ (
            хоть она и расположена во внутреннем периметре ИТ-инфраструктуры) получить доступ к внутренней доверенной зоне, по
            соображениям безопасности, должно быть нельзя.

### Популярные способы выхода за рамки сети ДМЗ

**Компрометация узлов внутри сети ДМЗ, имеющих доступ за рамки сети:**

- Веб-сервисы, чья БД находится в локальной сети компании
- Почтовый сервер, который имеет доступ к домену через протоколы получения доступа к информации из домена
- Терминальный сервер, предоставляющий доступы к файловым серверам и доменным службам

**Компрометация сетевого оборудования и переконфигурация устройств и списков контроля доступа:**

- Компрометация оборудования Cisco, Juniper, MikroTik через известные уязвимости
- Использование простых паролей или подбор паролей через доступные панели администрирования сетевого оборудования
- Приведение к отказу в обслуживании сетевого оборудования для сброса настроек

**Компрометация клиентов, входящих в DMZ сеть на управляемые узлы:**

- Эксплуатация уязвимостей SSH-агентов при подключении к скомпрометированному SSH-серверу
- Эксплуатация уязвимостей браузеров при подключении клиента из локальной сети к скомпрометированному веб-приложению (
  уязвимости XSS, UXSS, CSRF, Browser RCE и пр.)
- Кража учетных данных клиентов и администраторов на скомпрометированных узлах в ДМЗ и переиспользование их для
  попадания
  в локальную сеть

**Обнаружение лазеек (отдельных сегментов / протоколов), которым предоставлен доступ за рамки сети ДМЗ:**

- Обнаружение MultiCast, AnyCast протоколов в трафике, которые могут быть использованы для проведения атак
- Обнаружение доступных из ДМЗ сети логических сегментов локальной сети компании
- Обнаружение протоколов (в т.ч. их стандартных портов), которым позволено выходить за рамки сети ДМЗ (DNS, LDAP, SSH, и
  пр.)

### Компрометация сетевого оборудования: примеры и детали

У каждого вендора сетевого оборудования есть свои скелеты в шкафу: известные уязвимости и миссконфигурации.

Пример 1: **Cisco Smart Install misuse**

**Cisco Smart Install** — это программа Cisco, предназначенная для автоматизации начальной настройки и загрузки образа
операционной системы для нового оборудования Cisco. По умолчанию Cisco Smart Install активен на оборудовании Cisco и
использует протокол транспортного уровня TCP с номером порта 4786.

В 2018 году в этом протоколе была обнаружена критическая уязвимость CVE-2018-0171. Уровень угрозы составляет 9,8 по
шкале CVSS. Специально созданный пакет, отправленный на порт TCP/4786, на котором активен Cisco Smart Install, вызывает
переполнение буфера, что позволяет злоумышленнику:

- Принудительно перезагрузить устройство
- Вызвать RCE
- Похитить конфигурацию сетевого оборудования

Для эксплуатации этой уязвимости был разработан инструмент SIET (Smart Install Exploitation Tool), который позволяет
злоупотреблять Cisco Smart Install:

    sudo python siet.py -t -i 192.168.0.1

Параметры:

    -t проверить устройство для интеллектуальной установки
    -g получить конфигурацию устройства
    -c изменить конфигурацию устройства
    -C изменить несколько конфигураций устройства
    -u обновить IOS устройства
    -e выполнить команды в консоли устройства
    -i ip-адрес целевого устройства
    -l ip список целей (путь к файлу)

Пример 2. **Обратная разработка эксплойта Mikrotik из Vault 7 CIA Leaks**

**ChimayRed (CR)** - это эксплойт, который используется против маршрутизаторов MikroTik (MT) под управлением RouterOS.
Он используется для загрузки полезной нагрузки на маршрутизатор MT. Использует порт: tcp/80

Пример 3. **WinboxExploit**

Это критическая уязвимость WinBox (CVE-2018-14847), которая позволяет произвольно считывать пароли из файлов
конфигурации MirkoTik. Все версии RouterOS с 2015-05-28 по 2018-04-20 уязвимы к этому эксплойту. Использует порт:
tcp/8291

### Техники для выхода за рамки сети ДМЗ

Достаточно изучить 3 техники, позволяющие воспользоваться любым из описанных выше способов:

- Сканирование сети: для последующей компрометации узлов сети и обнаружения лазеек
- Анализ трафика: для поиска протоколов, которые можно атаковать в последствии
- MiTM атаки: для получения доступа к управлению трафиком за пределами сети ДМЗ